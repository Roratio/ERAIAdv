<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ERAIAdv 画面認識設定ツール (Vision Calibration)</title>
    <style>
        body {
            font-family: "Meiryo", "Yu Gothic", sans-serif;
            padding: 20px;
            background-color: #f4f6f9;
            color: #333;
        }

        .container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        .canvas-container {
            position: relative;
            border: 2px solid #ddd;
            background: #fff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        canvas {
            cursor: crosshair;
            display: block;
        }

        .controls {
            min-width: 350px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .region-list {
            border: 1px solid #ddd;
            padding: 10px;
            max-height: 500px;
            overflow-y: auto;
            background: #fff;
            border-radius: 4px;
        }

        .region-item {
            background: #f9f9f9;
            padding: 10px;
            margin-bottom: 8px;
            border-left: 5px solid #007bff;
            display: flex;
            flex-direction: column;
            gap: 8px;
            border-radius: 2px;
        }

        .region-item select {
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
            width: 100%;
            box-sizing: border-box;
        }

        .btn {
            padding: 10px 20px;
            cursor: pointer;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            font-weight: bold;
            transition: background 0.2s;
        }

        .btn:hover {
            background: #0056b3;
        }

        .btn.delete {
            background: #dc3545;
            font-size: 0.8em;
            padding: 5px 10px;
            align-self: flex-end;
        }

        .btn.delete:hover {
            background: #a71d2a;
        }

        textarea {
            width: 100%;
            height: 200px;
            font-family: monospace;
            border: 1px solid #ccc;
            padding: 10px;
            box-sizing: border-box;
        }

        h1 {
            margin-top: 0;
            color: #0056b3;
        }

        h2 {
            margin: 0 0 10px 0;
            font-size: 1.2em;
            border-bottom: 2px solid #eee;
            padding-bottom: 5px;
        }

        .guide {
            background: #e9ecef;
            padding: 15px;
            border-radius: 5px;
            border-left: 5px solid #17a2b8;
            margin-bottom: 20px;
        }
    </style>
</head>

<body>
    <h1>ERAIAdv 画面認識設定ツール</h1>

    <div class="guide">
        <strong>使い方:</strong><br>
        1. 「画像を選択」ボタンから、ゲームのロード画面のスクリーンショット (1920x1080推奨) を読み込んでください。<br>
        2. 画面上の<strong>「プレイヤー名」</strong>や<strong>「キャラクター名」</strong>を、マウスでドラッグして四角く囲んでください。<br>
        3. 右側のリストに追加された項目のプルダウンから、それが何の情報か（例: <code>enemy1_name</code>）を選んでください。<br>
        4. 全員の指定が終わったら「設定JSONを生成」ボタンを押し、出てきたテキストをコピーして保存してください。
    </div>

    <input type="file" id="imageLoader" accept="image/*">
    <br>

    <div class="container">
        <div class="canvas-container">
            <canvas id="imageCanvas"></canvas>
        </div>

        <div class="controls">
            <h2>認識エリア一覧 (Regions)</h2>
            <div id="regionList" class="region-list">
                <p style="color: #888; text-align: center;">まだエリアが指定されていません。<br>左の画像の上でドラッグしてください。</p>
            </div>

            <button class="btn" onclick="generateJSON()">設定JSONを生成 (Generate JSON)</button>
            <textarea id="jsonOutput" readonly placeholder="ここに生成されたJSONが表示されます..."></textarea>
        </div>
    </div>

    <script>
        const imageLoader = document.getElementById('imageLoader');
        const canvas = document.getElementById('imageCanvas');
        const ctx = canvas.getContext('2d');
        const regionListDiv = document.getElementById('regionList');
        const jsonOutput = document.getElementById('jsonOutput');

        let img = new Image();
        let regions = [];
        let isDrawing = false;
        let startX, startY;

        // 定義済みのラベルリスト (カテゴリ付き)
        const PREDEFINED_GROUPS = [
            {
                label: "ロード画面 / Tab画面 (Player Info)",
                options: []
            },
            {
                label: "1. ゲーム全体情報 (Game State)",
                options: [
                    { value: "restricted_area_timer", text: "爆発タイマー残り時間" },
                    { value: "day_count", text: "日付 (Day Count)" },
                    { value: "day_night_indicator", text: "昼夜 (Day/Night)" },
                    { value: "phase_timer", text: "今日の残り時間" },
                    { value: "objective_info", text: "オブジェクト (Alpha/Omega)" },
                    { value: "teams_remaining", text: "残りチーム数" },
                    { value: "survivors_remaining", text: "残り人数" },
                    { value: "team_kill_count", text: "チームキル数" },
                    { value: "minimap", text: "ミニマップ" }
                ]
            },
            {
                label: "2. プレイヤー自身の情報 (Self)",
                options: [
                    { value: "player_icon", text: "アイコン" },
                    { value: "player_level", text: "レベル" },
                    { value: "player_hp_bar", text: "HPバー" },
                    { value: "player_credits", text: "所持クレジット" },
                    { value: "player_kill_count", text: "キル数" },
                    { value: "player_assist_count", text: "アシスト数" },
                    { value: "player_stats_panel", text: "ステータス詳細" }
                ]
            },
            {
                label: "3. スキル・アクション (Skills)",
                options: [
                    { value: "skill_q", text: "Qスキル" },
                    { value: "skill_w", text: "Wスキル" },
                    { value: "skill_e", text: "Eスキル" },
                    { value: "skill_r", text: "Rスキル (Ult)" },
                    { value: "skill_passive", text: "パッシブ" },
                    { value: "skill_weapon", text: "武器スキル (D)" },
                    { value: "skill_tactical", text: "戦術スキル (F)" },
                    { value: "tactical_skill_gauge", text: "ガジェットエネルギー" }
                ]
            },
            {
                label: "4. 装備・インベントリ (Inventory)",
                options: [
                    { value: "equip_weapon", text: "装備_武器" },
                    { value: "equip_chest", text: "装備_服" },
                    { value: "equip_head", text: "装備_頭" },
                    { value: "equip_arm", text: "装備_腕" },
                    { value: "equip_leg", text: "装備_足" },
                    { value: "inventory_slot_1", text: "持ち物 1" },
                    { value: "inventory_slot_2", text: "持ち物 2" }
                ]
            },
            {
                label: "5. 味方情報 (Teammates)",
                options: [
                    { value: "ally_1_icon", text: "味方A アイコン" },
                    { value: "ally_1_level", text: "味方A レベル" },
                    { value: "ally_1_ult_status", text: "味方A Ult状況" },
                    { value: "ally_1_hp_bar", text: "味方A HP" },
                    { value: "ally_2_icon", text: "味方B アイコン" },
                    { value: "ally_2_level", text: "味方B レベル" },
                    { value: "ally_2_ult_status", text: "味方B Ult状況" },
                    { value: "ally_2_hp_bar", text: "味方B HP" }
                ]
            }
        ];

        // プレイヤー名（動的生成）
        for (let i = 1; i <= 8; i++) {
            PREDEFINED_GROUPS[0].options.push({ value: `player${i}_name`, text: `Player ${i} Name (名前)` });
            PREDEFINED_GROUPS[0].options.push({ value: `player${i}_char`, text: `Player ${i} Char (キャラ)` });
        }

        imageLoader.addEventListener('change', handleImage, false);

        function handleImage(e) {
            const reader = new FileReader();
            reader.onload = function (event) {
                img.onload = function () {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    draw();
                }
                img.src = event.target.result;
            }
            reader.readAsDataURL(e.target.files[0]);
        }

        canvas.addEventListener('mousedown', (e) => {
            if (!img.src) return;
            const rect = canvas.getBoundingClientRect();
            startX = (e.clientX - rect.left);
            startY = (e.clientY - rect.top);
            isDrawing = true;
        });

        canvas.addEventListener('mousemove', (e) => {
            if (!isDrawing) return;
            const rect = canvas.getBoundingClientRect();
            const currentX = (e.clientX - rect.left);
            const currentY = (e.clientY - rect.top);

            draw();
            ctx.strokeStyle = 'red';
            ctx.lineWidth = 2;
            ctx.strokeRect(startX, startY, currentX - startX, currentY - startY);
        });

        canvas.addEventListener('mouseup', (e) => {
            if (!isDrawing) return;
            isDrawing = false;

            const rect = canvas.getBoundingClientRect();
            const endX = (e.clientX - rect.left);
            const endY = (e.clientY - rect.top);

            const x = Math.min(startX, endX);
            const y = Math.min(startY, endY);
            const w = Math.abs(endX - startX);
            const h = Math.abs(endY - startY);

            if (w < 5 || h < 5) return;

            // 次のラベルを推測 (簡易実装: カスタム番号)
            const nextLabel = `custom_region_${regions.length + 1}`;

            const newRegion = {
                id: Date.now(),
                label: nextLabel,
                rect: { x: Math.round(x), y: Math.round(y), w: Math.round(w), h: Math.round(h) }
            };

            regions.push(newRegion);
            updateList();
            draw();
        });

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0);

            regions.forEach(r => {
                ctx.strokeStyle = '#007bff';
                ctx.lineWidth = 2;
                ctx.strokeRect(r.rect.x, r.rect.y, r.rect.w, r.rect.h);

                ctx.fillStyle = 'rgba(0, 123, 255, 0.3)';
                ctx.fillRect(r.rect.x, r.rect.y, r.rect.w, r.rect.h);

                ctx.fillStyle = 'white';
                ctx.font = 'bold 12px Arial';
                ctx.shadowColor = 'black';
                ctx.shadowBlur = 4;
                ctx.fillText(r.label, r.rect.x, r.rect.y - 5);
                ctx.shadowBlur = 0;
            });
        }

        function updateList() {
            regionListDiv.innerHTML = '';
            if (regions.length === 0) {
                regionListDiv.innerHTML = '<p style="color: #888; text-align: center;">まだエリアが指定されていません。<br>左の画像の上でドラッグしてください。</p>';
                return;
            }

            regions.forEach((r) => {
                const item = document.createElement('div');
                item.className = 'region-item';

                // プルダウンメニューの生成 (入力補助用) with OptGroup
                let optionsHtml = '<option value="" disabled selected>▼ プリセットから選ぶ</option>';

                PREDEFINED_GROUPS.forEach(group => {
                    optionsHtml += `<optgroup label="${group.label}">`;
                    group.options.forEach(opt => {
                        const selected = r.label === opt.value ? 'selected' : ''; // ここでは選択状態は反映されないが(input優先)、再描画時のため
                        optionsHtml += `<option value="${opt.value}">${opt.text}</option>`;
                    });
                    optionsHtml += `</optgroup>`;
                });

                item.innerHTML = `
                    <div style="display: flex; gap: 5px; align-items: center;">
                        <input type="text" value="${r.label}" onchange="updateLabel(${r.id}, this.value)" style="flex-grow: 1; padding: 5px;" placeholder="ラベル名を入力...">
                        <select onchange="this.previousElementSibling.value=this.value; updateLabel(${r.id}, this.value)" style="width: 30px;" title="プリセットから入力">
                            ${optionsHtml}
                        </select>
                    </div>
                    <small>x:${r.rect.x}, y:${r.rect.y}, w:${r.rect.w}, h:${r.rect.h}</small>
                    <button class="btn delete" onclick="deleteRegion(${r.id})">削除 (Delete)</button>
                `;
                regionListDiv.appendChild(item);
            });
        }

        window.updateLabel = function (id, newLabel) {
            const r = regions.find(r => r.id === id);
            if (r) {
                r.label = newLabel;
                draw(); // キャンバス上のラベルも更新
            }
        };

        window.deleteRegion = function (id) {
            regions = regions.filter(r => r.id !== id);
            updateList();
            draw();
        };

        window.generateJSON = function () {
            const output = {};
            regions.forEach(r => {
                output[r.label] = r.rect;
            });
            jsonOutput.value = JSON.stringify(output, null, 4);
        };
    </script>
</body>

</html>